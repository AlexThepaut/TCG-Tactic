# 1.1C: Backend Core Infrastructure

## üéØ Task Overview
**Agent**: @backend-architect
**Duration**: 4 hours
**Dependencies**: 1.1A (Project Architecture), 1.1B (Database Schema)
**Risk Level**: Low
**Parallel Execution**: ‚ùå Sequential after 1.1A and 1.1B

## üìã Objective
Setup Express server with TypeScript, middleware (cors, helmet, morgan), PostgreSQL connection, environment configuration, and health check endpoint. Create foundational backend infrastructure ready for game services.

## üéØ Deliverables

### 1. Express Server Setup
```typescript
// src/app.ts
import express from 'express';
import cors from 'cors';
import helmet from 'helmet';
import morgan from 'morgan';
import dotenv from 'dotenv';
import { connectDatabase } from './config/database';
import { healthRoutes } from './routes/health';
import { errorHandler } from './middleware/errorHandler';

dotenv.config();

const app = express();
const PORT = process.env.PORT || 5000;

// Security middleware
app.use(helmet());
app.use(cors({
    origin: process.env.FRONTEND_URL || 'http://localhost:3000',
    credentials: true
}));

// Logging
app.use(morgan('combined'));

// Body parsing
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true }));

// Health check routes
app.use('/health', healthRoutes);

// Error handling
app.use(errorHandler);

// Database connection
connectDatabase();

export { app };
```

### 2. Database Connection
```typescript
// src/config/database.ts
import { Pool } from 'pg';
import { logger } from '../utils/logger';

export const pool = new Pool({
    host: process.env.DB_HOST || 'localhost',
    port: parseInt(process.env.DB_PORT || '5432'),
    database: process.env.DB_NAME || 'tcg_db',
    user: process.env.DB_USER || 'tcg_user',
    password: process.env.DB_PASSWORD || 'password',
    max: 20,
    idleTimeoutMillis: 30000,
    connectionTimeoutMillis: 2000,
});

export async function connectDatabase(): Promise<void> {
    try {
        const client = await pool.connect();
        logger.info('Database connected successfully');
        client.release();
    } catch (error) {
        logger.error('Database connection failed:', error);
        process.exit(1);
    }
}

export async function closeDatabase(): Promise<void> {
    await pool.end();
    logger.info('Database connection closed');
}
```

### 3. Environment Configuration
```typescript
// src/config/environment.ts
import { z } from 'zod';

const envSchema = z.object({
    NODE_ENV: z.enum(['development', 'production', 'test']).default('development'),
    PORT: z.string().transform(Number).default(5000),

    // Database
    DB_HOST: z.string().default('localhost'),
    DB_PORT: z.string().transform(Number).default(5432),
    DB_NAME: z.string().default('tcg_db'),
    DB_USER: z.string().default('tcg_user'),
    DB_PASSWORD: z.string().default('password'),

    // Redis
    REDIS_HOST: z.string().default('localhost'),
    REDIS_PORT: z.string().transform(Number).default(6379),

    // JWT
    JWT_SECRET: z.string().min(32),
    JWT_EXPIRES_IN: z.string().default('24h'),

    // CORS
    FRONTEND_URL: z.string().url().default('http://localhost:3000'),

    // API Keys
    OPENAI_API_KEY: z.string().optional(),
});

export const env = envSchema.parse(process.env);
export type Environment = z.infer<typeof envSchema>;
```

### 4. Health Check Routes
```typescript
// src/routes/health.ts
import { Router, Request, Response } from 'express';
import { pool } from '../config/database';
import { logger } from '../utils/logger';

const router = Router();

// Basic health check
router.get('/', (req: Request, res: Response) => {
    res.status(200).json({
        status: 'healthy',
        timestamp: new Date().toISOString(),
        service: 'TCG Tactique Backend',
        version: process.env.npm_package_version || '1.0.0'
    });
});

// Database health check
router.get('/db', async (req: Request, res: Response) => {
    try {
        const client = await pool.connect();
        const result = await client.query('SELECT NOW()');
        client.release();

        res.status(200).json({
            status: 'healthy',
            database: 'connected',
            timestamp: result.rows[0].now
        });
    } catch (error) {
        logger.error('Database health check failed:', error);
        res.status(503).json({
            status: 'unhealthy',
            database: 'disconnected',
            error: 'Database connection failed'
        });
    }
});

// Detailed system health
router.get('/detailed', async (req: Request, res: Response) => {
    const healthData = {
        status: 'healthy',
        timestamp: new Date().toISOString(),
        service: 'TCG Tactique Backend',
        version: process.env.npm_package_version || '1.0.0',
        environment: process.env.NODE_ENV || 'development',
        uptime: process.uptime(),
        memory: process.memoryUsage(),
        cpu: process.cpuUsage(),
        checks: {
            database: false,
            redis: false
        }
    };

    // Database check
    try {
        const client = await pool.connect();
        await client.query('SELECT 1');
        client.release();
        healthData.checks.database = true;
    } catch (error) {
        healthData.status = 'unhealthy';
        logger.error('Database health check failed:', error);
    }

    // TODO: Add Redis health check when implemented

    const statusCode = healthData.status === 'healthy' ? 200 : 503;
    res.status(statusCode).json(healthData);
});

export { router as healthRoutes };
```

### 5. Middleware Setup
```typescript
// src/middleware/errorHandler.ts
import { Request, Response, NextFunction } from 'express';
import { logger } from '../utils/logger';

export interface AppError extends Error {
    statusCode?: number;
    isOperational?: boolean;
}

export function errorHandler(
    err: AppError,
    req: Request,
    res: Response,
    next: NextFunction
): void {
    const statusCode = err.statusCode || 500;
    const message = err.message || 'Internal Server Error';

    logger.error('Error occurred:', {
        message: err.message,
        stack: err.stack,
        url: req.url,
        method: req.method,
        ip: req.ip,
        userAgent: req.get('User-Agent')
    });

    res.status(statusCode).json({
        error: {
            message,
            status: statusCode,
            ...(process.env.NODE_ENV === 'development' && { stack: err.stack })
        }
    });
}

// src/middleware/asyncHandler.ts
export function asyncHandler(
    fn: (req: Request, res: Response, next: NextFunction) => Promise<any>
) {
    return (req: Request, res: Response, next: NextFunction) => {
        Promise.resolve(fn(req, res, next)).catch(next);
    };
}

// src/middleware/validateRequest.ts
import { z } from 'zod';

export function validateRequest(schema: {
    body?: z.ZodSchema;
    query?: z.ZodSchema;
    params?: z.ZodSchema;
}) {
    return (req: Request, res: Response, next: NextFunction) => {
        try {
            if (schema.body) {
                req.body = schema.body.parse(req.body);
            }
            if (schema.query) {
                req.query = schema.query.parse(req.query);
            }
            if (schema.params) {
                req.params = schema.params.parse(req.params);
            }
            next();
        } catch (error) {
            if (error instanceof z.ZodError) {
                res.status(400).json({
                    error: 'Validation failed',
                    details: error.errors
                });
            } else {
                next(error);
            }
        }
    };
}
```

### 6. Logging System
```typescript
// src/utils/logger.ts
import winston from 'winston';

const logger = winston.createLogger({
    level: process.env.LOG_LEVEL || 'info',
    format: winston.format.combine(
        winston.format.timestamp(),
        winston.format.errors({ stack: true }),
        winston.format.json()
    ),
    defaultMeta: { service: 'tcg-backend' },
    transports: [
        new winston.transports.File({
            filename: 'logs/error.log',
            level: 'error'
        }),
        new winston.transports.File({
            filename: 'logs/combined.log'
        }),
    ],
});

if (process.env.NODE_ENV !== 'production') {
    logger.add(new winston.transports.Console({
        format: winston.format.combine(
            winston.format.colorize(),
            winston.format.simple()
        )
    }));
}

export { logger };
```

### 7. Server Entry Point
```typescript
// src/server.ts
import { app } from './app';
import { logger } from './utils/logger';
import { env } from './config/environment';

const server = app.listen(env.PORT, () => {
    logger.info(`Server running on port ${env.PORT} in ${env.NODE_ENV} mode`);
});

// Graceful shutdown
process.on('SIGTERM', () => {
    logger.info('SIGTERM received, shutting down gracefully');
    server.close(() => {
        logger.info('Process terminated');
        process.exit(0);
    });
});

process.on('SIGINT', () => {
    logger.info('SIGINT received, shutting down gracefully');
    server.close(() => {
        logger.info('Process terminated');
        process.exit(0);
    });
});

export { server };
```

### 8. Package.json Scripts
```json
{
  "name": "tcg-tactique-backend",
  "scripts": {
    "dev": "nodemon src/server.ts",
    "build": "tsc",
    "start": "node dist/server.js",
    "test": "jest",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage",
    "lint": "eslint src/**/*.ts",
    "lint:fix": "eslint src/**/*.ts --fix",
    "db:migrate": "knex migrate:latest",
    "db:rollback": "knex migrate:rollback",
    "db:seed": "knex seed:run"
  },
  "dependencies": {
    "express": "^4.18.2",
    "cors": "^2.8.5",
    "helmet": "^7.0.0",
    "morgan": "^1.10.0",
    "dotenv": "^16.3.1",
    "pg": "^8.11.3",
    "winston": "^3.10.0",
    "zod": "^3.22.2"
  },
  "devDependencies": {
    "@types/express": "^4.17.17",
    "@types/cors": "^2.8.13",
    "@types/morgan": "^1.9.4",
    "@types/pg": "^8.10.2",
    "@types/node": "^20.5.0",
    "typescript": "^5.1.6",
    "nodemon": "^3.0.1",
    "ts-node": "^10.9.1",
    "jest": "^29.6.2",
    "@types/jest": "^29.5.4",
    "ts-jest": "^29.1.1",
    "eslint": "^8.47.0",
    "@typescript-eslint/eslint-plugin": "^6.4.0",
    "@typescript-eslint/parser": "^6.4.0"
  }
}
```

## ‚úÖ Acceptance Criteria

### Functional Requirements
- [ ] Express server starts without errors
- [ ] Database connection established successfully
- [ ] Health check endpoints responding correctly
- [ ] Environment variables loaded and validated
- [ ] Middleware chain working (CORS, helmet, morgan, error handling)

### Quality Requirements
- [ ] TypeScript compilation with strict mode
- [ ] Comprehensive error handling and logging
- [ ] Request validation using Zod schemas
- [ ] Security headers configured via helmet
- [ ] Graceful shutdown handling

### Performance Requirements
- [ ] Server startup < 5 seconds
- [ ] Health check response < 100ms
- [ ] Database connection pool optimized
- [ ] Memory usage < 100MB at startup

## üß™ Validation Tests

### Automated Tests
```typescript
// __tests__/app.test.ts
import request from 'supertest';
import { app } from '../src/app';

describe('Backend Core', () => {
    test('should respond to health check', async () => {
        const response = await request(app)
            .get('/health')
            .expect(200);

        expect(response.body.status).toBe('healthy');
    });

    test('should handle database health check', async () => {
        const response = await request(app)
            .get('/health/db')
            .expect(200);

        expect(response.body.database).toBe('connected');
    });

    test('should handle 404 errors', async () => {
        await request(app)
            .get('/nonexistent')
            .expect(404);
    });
});
```

### Manual Validation
```bash
# Test 1: Server startup
npm run dev

# Test 2: Health endpoints
curl http://localhost:5000/health
curl http://localhost:5000/health/db
curl http://localhost:5000/health/detailed

# Test 3: Error handling
curl http://localhost:5000/nonexistent

# Test 4: CORS headers
curl -H "Origin: http://localhost:3000" http://localhost:5000/health
```

## üîß SuperClaude Command

```bash
@Task "backend-architect" "Setup Express backend infrastructure for TCG Tactique with production-ready configuration:

CORE SERVER:
- Express server with TypeScript strict mode
- Environment configuration with Zod validation
- PostgreSQL connection pool with error handling
- Security middleware: helmet, CORS, rate limiting
- Request logging with Winston

MIDDLEWARE STACK:
- CORS configured for frontend communication
- Request validation using Zod schemas
- Error handling with proper status codes and logging
- Async request wrapper for error propagation
- Body parsing with size limits

HEALTH MONITORING:
- Basic health endpoint (/health)
- Database connectivity check (/health/db)
- Detailed system metrics (/health/detailed)
- Graceful shutdown handling

DEVELOPMENT SETUP:
- Hot reload with nodemon
- TypeScript compilation and watching
- Database migration scripts
- Comprehensive logging to files and console

VALIDATION:
- Server starts without errors in < 5 seconds
- All health endpoints respond correctly
- Database connection established
- TypeScript compilation successful with strict mode
- Error handling covers all edge cases"
```

## üìä Success Metrics
- **Startup Time**: < 5 seconds
- **Response Time**: Health checks < 100ms
- **Memory Usage**: < 100MB at startup
- **Uptime**: 99.9% in development environment

## üîó Dependencies & Integration
- **Requires**: 1.1A (Project Architecture), 1.1B (Database Schema)
- **Enables**: All backend services (WebSocket, game logic, authentication)
- **Provides**: Foundation for all API routes and real-time services

## üìù Notes
- Configure for development speed with production patterns
- Implement comprehensive logging for debugging game logic
- Ensure environment validation catches configuration errors early
- Design middleware stack for easy extension with authentication and game services