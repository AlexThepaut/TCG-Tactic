# 1.1E: DevOps & Environment Configuration

## üéØ Task Overview
**Agent**: @devops-architect
**Duration**: 3 hours
**Dependencies**: 1.1C (Backend Core), 1.1D (Frontend Setup)
**Risk Level**: Low
**Parallel Execution**: ‚ùå Sequential after backend and frontend setup

## üìã Objective
Create complete development environment with Docker containers, hot reload for frontend/backend, environment variables properly configured, and development databases isolated. Ensure full stack running smoothly.

## üéØ Deliverables

### 1. Docker Compose Development
```yaml
# docker-compose.yml
version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: tcg-postgres
    environment:
      POSTGRES_DB: tcg_db
      POSTGRES_USER: tcg_user
      POSTGRES_PASSWORD: tcg_password
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8"
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backend/database/init:/docker-entrypoint-initdb.d
    networks:
      - tcg-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U tcg_user -d tcg_db"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: tcg-redis
    command: redis-server --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - tcg-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Backend Service
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    container_name: tcg-backend
    environment:
      NODE_ENV: development
      PORT: 5000
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: tcg_db
      DB_USER: tcg_user
      DB_PASSWORD: tcg_password
      REDIS_HOST: redis
      REDIS_PORT: 6379
      JWT_SECRET: dev-jwt-secret-change-in-production
      FRONTEND_URL: http://localhost:3000
    ports:
      - "5000:5000"
    volumes:
      - ./backend:/app
      - /app/node_modules
      - ./backend/logs:/app/logs
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - tcg-network
    develop:
      watch:
        - action: sync
          path: ./backend/src
          target: /app/src
        - action: rebuild
          path: ./backend/package.json

  # Frontend Service
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: tcg-frontend
    environment:
      VITE_API_URL: http://localhost:5000
      VITE_WS_URL: ws://localhost:5000
    ports:
      - "3000:3000"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    depends_on:
      - backend
    networks:
      - tcg-network
    develop:
      watch:
        - action: sync
          path: ./frontend/src
          target: /app/src
        - action: rebuild
          path: ./frontend/package.json

networks:
  tcg-network:
    driver: bridge

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
```

### 2. Backend Dockerfile (Development)
```dockerfile
# backend/Dockerfile.dev
FROM node:18-alpine

WORKDIR /app

# Install dependencies
COPY package*.json ./
RUN npm ci

# Create logs directory
RUN mkdir -p logs

# Copy source code
COPY . .

# Expose port
EXPOSE 5000

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=10s --retries=3 \
  CMD curl -f http://localhost:5000/health || exit 1

# Install curl for health check
RUN apk add --no-cache curl

# Start development server
CMD ["npm", "run", "dev"]
```

### 3. Frontend Dockerfile (Development)
```dockerfile
# frontend/Dockerfile.dev
FROM node:18-alpine

WORKDIR /app

# Install dependencies
COPY package*.json ./
RUN npm ci

# Copy source code
COPY . .

# Expose port
EXPOSE 3000

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=10s --retries=3 \
  CMD curl -f http://localhost:3000 || exit 1

# Install curl for health check
RUN apk add --no-cache curl

# Start development server
CMD ["npm", "run", "dev", "--", "--host", "0.0.0.0"]
```

### 4. Production Docker Compose
```yaml
# docker-compose.prod.yml
version: '3.8'

services:
  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: tcg-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
    depends_on:
      - backend
      - frontend
    networks:
      - tcg-network

  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: tcg-postgres-prod
    environment:
      POSTGRES_DB: ${DB_NAME}
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_prod_data:/var/lib/postgresql/data
    networks:
      - tcg-network
    restart: unless-stopped

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: tcg-redis-prod
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_prod_data:/data
    networks:
      - tcg-network
    restart: unless-stopped

  # Backend Service
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.prod
    container_name: tcg-backend-prod
    environment:
      NODE_ENV: production
      PORT: 5000
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      JWT_SECRET: ${JWT_SECRET}
    depends_on:
      - postgres
      - redis
    networks:
      - tcg-network
    restart: unless-stopped

  # Frontend Service
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
    container_name: tcg-frontend-prod
    environment:
      VITE_API_URL: ${API_URL}
      VITE_WS_URL: ${WS_URL}
    networks:
      - tcg-network
    restart: unless-stopped

networks:
  tcg-network:
    driver: bridge

volumes:
  postgres_prod_data:
    driver: local
  redis_prod_data:
    driver: local
```

### 5. Environment Configuration
```bash
# .env.example
# Development Environment Variables

# Application
NODE_ENV=development
PORT=5000

# Database
DB_HOST=localhost
DB_PORT=5432
DB_NAME=tcg_db
DB_USER=tcg_user
DB_PASSWORD=tcg_password

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# Authentication
JWT_SECRET=your-super-secure-jwt-secret-change-this
JWT_EXPIRES_IN=24h

# Frontend
FRONTEND_URL=http://localhost:3000
VITE_API_URL=http://localhost:5000
VITE_WS_URL=ws://localhost:5000

# API Keys (Optional for development)
OPENAI_API_KEY=your-openai-api-key

# Logging
LOG_LEVEL=info

# Security
BCRYPT_ROUNDS=12
```

```bash
# .env.production.example
# Production Environment Variables

# Application
NODE_ENV=production
PORT=5000

# Database
DB_HOST=your-db-host
DB_PORT=5432
DB_NAME=tcg_production
DB_USER=tcg_prod_user
DB_PASSWORD=super-secure-password

# Redis
REDIS_HOST=your-redis-host
REDIS_PORT=6379
REDIS_PASSWORD=super-secure-redis-password

# Authentication
JWT_SECRET=your-production-jwt-secret-64-chars-minimum
JWT_EXPIRES_IN=24h

# Frontend URLs
FRONTEND_URL=https://your-domain.com
API_URL=https://api.your-domain.com
WS_URL=wss://api.your-domain.com

# API Keys
OPENAI_API_KEY=your-production-openai-api-key

# Logging
LOG_LEVEL=warn

# Security
BCRYPT_ROUNDS=14
```

### 6. Development Scripts
```bash
#!/bin/bash
# scripts/dev-setup.sh

echo "üöÄ Setting up TCG Tactique development environment..."

# Create environment file if it doesn't exist
if [ ! -f .env ]; then
    echo "üìù Creating .env file from template..."
    cp .env.example .env
    echo "‚úÖ Please review and update .env file with your configuration"
fi

# Build and start services
echo "üê≥ Building and starting Docker services..."
docker-compose down -v
docker-compose build --no-cache
docker-compose up -d

# Wait for services to be healthy
echo "‚è≥ Waiting for services to be ready..."
sleep 10

# Check service health
echo "üè• Checking service health..."
docker-compose ps

# Run database migrations
echo "üìä Running database migrations..."
docker-compose exec backend npm run db:migrate

# Seed test data
echo "üå± Seeding test data..."
docker-compose exec backend npm run db:seed

echo "‚úÖ Development environment ready!"
echo "üåê Frontend: http://localhost:3000"
echo "üîß Backend: http://localhost:5000"
echo "üìä Database: localhost:5432"
echo "üíæ Redis: localhost:6379"
```

```bash
#!/bin/bash
# scripts/dev-reset.sh

echo "üîÑ Resetting development environment..."

# Stop all services
docker-compose down -v

# Remove volumes
docker volume prune -f

# Rebuild and restart
docker-compose build --no-cache
docker-compose up -d

# Wait and setup
sleep 15
docker-compose exec backend npm run db:migrate
docker-compose exec backend npm run db:seed

echo "‚úÖ Environment reset complete!"
```

```bash
#!/bin/bash
# scripts/logs.sh

echo "üìã Viewing service logs..."

if [ "$1" = "backend" ]; then
    docker-compose logs -f backend
elif [ "$1" = "frontend" ]; then
    docker-compose logs -f frontend
elif [ "$1" = "db" ]; then
    docker-compose logs -f postgres
elif [ "$1" = "redis" ]; then
    docker-compose logs -f redis
else
    docker-compose logs -f
fi
```

### 7. Health Check Script
```bash
#!/bin/bash
# scripts/health-check.sh

echo "üè• Running health checks..."

# Check if services are running
services=("postgres" "redis" "backend" "frontend")
for service in "${services[@]}"; do
    if docker-compose ps -q $service > /dev/null; then
        echo "‚úÖ $service: Running"
    else
        echo "‚ùå $service: Not running"
    fi
done

# Check service health endpoints
echo ""
echo "üåê Checking API endpoints..."

# Backend health
if curl -f http://localhost:5000/health > /dev/null 2>&1; then
    echo "‚úÖ Backend API: Healthy"
else
    echo "‚ùå Backend API: Unhealthy"
fi

# Database health
if curl -f http://localhost:5000/health/db > /dev/null 2>&1; then
    echo "‚úÖ Database: Connected"
else
    echo "‚ùå Database: Disconnected"
fi

# Frontend
if curl -f http://localhost:3000 > /dev/null 2>&1; then
    echo "‚úÖ Frontend: Accessible"
else
    echo "‚ùå Frontend: Not accessible"
fi

echo ""
echo "üìä Service status:"
docker-compose ps
```

### 8. Monitoring Configuration
```yaml
# docker-compose.monitoring.yml
version: '3.8'

services:
  # Prometheus
  prometheus:
    image: prom/prometheus:latest
    container_name: tcg-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
    networks:
      - tcg-network

  # Grafana
  grafana:
    image: grafana/grafana:latest
    container_name: tcg-grafana
    ports:
      - "3001:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin
    volumes:
      - grafana_data:/var/lib/grafana
    networks:
      - tcg-network

volumes:
  grafana_data:
    driver: local

networks:
  tcg-network:
    external: true
```

## ‚úÖ Acceptance Criteria

### Functional Requirements
- [ ] All Docker services start successfully
- [ ] Hot reload working for frontend and backend
- [ ] Database migrations run automatically
- [ ] Environment variables loaded correctly
- [ ] Health checks passing for all services

### Quality Requirements
- [ ] Services isolated and properly networked
- [ ] Volume persistence for database and logs
- [ ] Development and production configurations separated
- [ ] Service dependencies handled correctly
- [ ] Graceful shutdown and restart capabilities

### Performance Requirements
- [ ] Full stack startup < 2 minutes
- [ ] Hot reload response < 3 seconds
- [ ] Service health checks responsive
- [ ] Resource usage optimized for development

## üß™ Validation Tests

### Automated Validation
```bash
# Test script: scripts/test-environment.sh
#!/bin/bash

echo "üß™ Testing development environment..."

# Start environment
./scripts/dev-setup.sh

# Wait for services
sleep 30

# Run health checks
./scripts/health-check.sh

# Test hot reload
echo "üîÑ Testing hot reload..."

# Modify backend file
echo "// Test change" >> backend/src/app.ts
sleep 5

# Check if backend restarted
if docker-compose logs backend | grep -q "restarting"; then
    echo "‚úÖ Backend hot reload working"
else
    echo "‚ùå Backend hot reload failed"
fi

# Modify frontend file
echo "/* Test change */" >> frontend/src/App.tsx
sleep 5

# Frontend should rebuild automatically
echo "‚úÖ Frontend hot reload test completed"

# Clean up test changes
git checkout -- backend/src/app.ts frontend/src/App.tsx

echo "üéâ Environment testing completed!"
```

### Manual Validation
```bash
# Test 1: Full stack startup
./scripts/dev-setup.sh

# Test 2: Service health
./scripts/health-check.sh

# Test 3: Hot reload
# Modify files and verify automatic reload

# Test 4: Database connection
docker-compose exec backend npm run db:migrate

# Test 5: Environment reset
./scripts/dev-reset.sh
```

## üîß SuperClaude Command

```bash
@Task "devops-architect" "Create complete Docker development environment for TCG Tactique:

DOCKER SERVICES:
- PostgreSQL 15 with health checks and data persistence
- Redis 7 for caching and session management
- Backend service with hot reload and log mounting
- Frontend service with Vite dev server and hot reload
- Service networking and dependency management

DEVELOPMENT OPTIMIZATION:
- Hot reload for both frontend and backend code changes
- Volume mounting for source code and node_modules
- Environment variable management for all services
- Database migration and seeding automation
- Log aggregation and monitoring

ENVIRONMENT MANAGEMENT:
- Separate development and production configurations
- Environment variable templates and validation
- Service health checks and dependency ordering
- Graceful startup and shutdown procedures

DEVELOPER TOOLS:
- Setup scripts for one-command environment initialization
- Health check scripts for service validation
- Log viewing and debugging utilities
- Environment reset and cleanup tools

VALIDATION:
- All services start and reach healthy status
- Hot reload working for code changes
- Database migrations run successfully
- Environment variables loaded correctly
- Full stack accessible and functional"
```

## üìä Success Metrics
- **Startup Time**: Full environment < 2 minutes
- **Hot Reload**: Code changes reflected < 3 seconds
- **Reliability**: 99.9% uptime in development
- **Resource Usage**: Optimized for local development

## üîó Dependencies & Integration
- **Requires**: 1.1C (Backend Core), 1.1D (Frontend Setup)
- **Enables**: All development work with consistent environment
- **Provides**: Production-ready deployment foundation

## üìù Notes
- Optimize for development speed over production concerns
- Ensure cross-platform compatibility (Mac, Linux, Windows with WSL)
- Design for easy scaling to production deployment
- Include monitoring hooks for future observability needs