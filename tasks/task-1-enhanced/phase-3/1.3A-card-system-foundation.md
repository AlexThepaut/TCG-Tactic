# Task 1.3A: Card System Foundation

**Phase**: 3 - Game Mechanics
**Priority**: Critical
**Estimated Time**: 3-4 days
**Dependencies**: Phase 1 database schema, Phase 2 Socket.io infrastructure

## ðŸŽ¯ Objective

Establish the backend foundation for card management and game data, creating a robust card system that supports TCG Tactique's faction-based gameplay with balanced statistics and extensible special abilities.

## ðŸ“‹ Requirements

### Functional Requirements

#### Card Data Model
- **Card Database Schema**: PostgreSQL tables for storing 120+ game cards
- **Card Properties**: Attack, Health, Cost (1-10 Void Echoes), Range, Type, Special Abilities
- **Faction Integration**: Support for three factions (Humans, Aliens, Robots)
- **Metadata Storage**: JSON fields for extensible special abilities and card effects
- **Version Control**: Support for future card rotation system

#### Faction System
- **Faction Definitions**: Humans (discipline/coordination), Aliens (evolution/adaptation), Robots (persistence/technology)
- **Formation Data**: Store faction-specific playable grid positions
- **Passive Abilities**: Framework for faction-specific passive powers
- **Card Distribution**: 40 cards per faction with balanced cost curves

#### Seed Data Generation
- **Balanced Statistics**: Create 120 cards (40 per faction) with balanced Attack/Health ratios
- **Cost Curve Distribution**: Proper distribution across 1-10 Void Echoes cost range
- **Unit Types**: Mix of different unit types with varied ranges and abilities
- **Spell Cards**: Include spell cards with immediate effects (future expansion)

### Technical Requirements

#### Database Schema
```sql
-- Core card table
CREATE TABLE cards (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL,
    faction VARCHAR(20) NOT NULL CHECK (faction IN ('humans', 'aliens', 'robots')),
    type VARCHAR(20) NOT NULL CHECK (type IN ('unit', 'spell')),
    cost INTEGER NOT NULL CHECK (cost >= 1 AND cost <= 10),
    attack INTEGER CHECK (attack >= 0 AND attack <= 20),
    health INTEGER CHECK (health >= 1 AND health <= 20),
    range INTEGER DEFAULT 1 CHECK (range >= 1 AND range <= 3),
    abilities JSONB DEFAULT '[]',
    description TEXT,
    flavor_text TEXT,
    image_url VARCHAR(255),
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Faction definitions
CREATE TABLE factions (
    id VARCHAR(20) PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    description TEXT,
    formation JSONB NOT NULL,
    passive_ability JSONB NOT NULL,
    color_theme VARCHAR(7) -- Hex color
);

-- Card abilities reference
CREATE TABLE card_abilities (
    id VARCHAR(50) PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT NOT NULL,
    effect_type VARCHAR(30) NOT NULL,
    parameters JSONB DEFAULT '{}'
);
```

#### API Endpoints
```typescript
// Card retrieval endpoints
GET /api/cards                    // Get all active cards
GET /api/cards/faction/:faction   // Get cards by faction
GET /api/cards/:id                // Get specific card
GET /api/factions                 // Get faction data
GET /api/factions/:id             // Get specific faction

// Admin endpoints (future)
POST /api/cards                   // Create new card
PUT /api/cards/:id                // Update card
DELETE /api/cards/:id             // Deactivate card
```

#### Data Validation
- **Cost Balance**: Ensure cost correlates with power level (Attack + Health)
- **Faction Distribution**: Validate 40 cards per faction
- **Ability Validation**: Ensure abilities reference valid ability types
- **Range Constraints**: Validate range values against game rules

## ðŸ—ï¸ Technical Architecture

### Backend Components

#### CardService
```typescript
interface CardService {
  // Card management
  getAllCards(): Promise<Card[]>;
  getCardsByFaction(faction: Faction): Promise<Card[]>;
  getCardById(id: string): Promise<Card | null>;

  // Faction management
  getAllFactions(): Promise<FactionData[]>;
  getFaction(id: Faction): Promise<FactionData | null>;

  // Validation
  validateCard(card: Partial<Card>): ValidationResult;
  calculatePowerLevel(card: Card): number;
}
```

#### Database Models
```typescript
interface Card {
  id: string;
  name: string;
  faction: 'humans' | 'aliens' | 'robots';
  type: 'unit' | 'spell';
  cost: number; // 1-10 Void Echoes
  attack?: number; // Units only
  health?: number; // Units only
  range?: number; // Attack range
  abilities: CardAbility[];
  description: string;
  flavorText?: string;
  imageUrl?: string;
  isActive: boolean;
}

interface FactionData {
  id: 'humans' | 'aliens' | 'robots';
  name: string;
  description: string;
  formation: boolean[][]; // 3x5 grid
  passiveAbility: PassiveAbility;
  colorTheme: string;
}

interface CardAbility {
  id: string;
  name: string;
  description: string;
  effectType: 'passive' | 'triggered' | 'activated';
  parameters: Record<string, any>;
}
```

### Seed Data Structure

#### Faction Formations
```typescript
const FACTION_FORMATIONS = {
  humans: [ // "Tactical Phalanx"
    [false, true, true, true, false],
    [false, true, true, true, false],
    [false, true, true, true, false]
  ],
  aliens: [ // "Living Swarm"
    [false, true, true, true, false],
    [true, true, true, true, true],
    [false, false, true, false, false]
  ],
  robots: [ // "Immortal Army"
    [true, true, true, true, true],
    [false, false, true, false, false],
    [false, true, true, true, false]
  ]
};
```

#### Sample Cards
```typescript
const SAMPLE_CARDS = [
  // Human Cards - Discipline/Coordination theme
  {
    name: "Tactical Squad",
    faction: "humans",
    type: "unit",
    cost: 2,
    attack: 2,
    health: 3,
    range: 1,
    abilities: [],
    description: "Basic human infantry unit with balanced stats"
  },
  {
    name: "Sniper",
    faction: "humans",
    type: "unit",
    cost: 3,
    attack: 3,
    health: 1,
    range: 3,
    abilities: [],
    description: "Long-range unit with high attack but low health"
  },

  // Alien Cards - Evolution/Adaptation theme
  {
    name: "Hive Drone",
    faction: "aliens",
    type: "unit",
    cost: 1,
    attack: 1,
    health: 1,
    range: 1,
    abilities: [{
      id: "swarm",
      name: "Swarm",
      description: "+1 attack for each adjacent alien unit",
      effectType: "passive",
      parameters: { bonus: 1 }
    }],
    description: "Weak alone, powerful in groups"
  },

  // Robot Cards - Persistence/Technology theme
  {
    name: "Combat Mech",
    faction: "robots",
    type: "unit",
    cost: 4,
    attack: 3,
    health: 4,
    range: 1,
    abilities: [{
      id: "armor",
      name: "Armor Plating",
      description: "Takes 1 less damage from attacks (minimum 1)",
      effectType: "passive",
      parameters: { reduction: 1 }
    }],
    description: "Heavily armored mechanical unit"
  }
];
```

## ðŸ”Œ Integration Requirements

### Database Integration
- **Connection Pool**: Efficient PostgreSQL connection management
- **Migrations**: Database schema migration scripts
- **Seeders**: Automated seed data insertion
- **Indexing**: Optimized queries for card retrieval

### API Integration
- **RESTful Endpoints**: Standard REST API for card data
- **Error Handling**: Comprehensive error responses
- **Validation Middleware**: Request validation for all endpoints
- **Documentation**: OpenAPI/Swagger documentation

### Future Extensibility
- **Card Rotation**: Framework for monthly card updates
- **AI Integration**: Prepare for AI-generated card content
- **Ability System**: Extensible framework for new card abilities
- **Balance Adjustments**: Support for card balance updates

## âœ… Acceptance Criteria

### Database Requirements
- [ ] Complete PostgreSQL schema created and migrated
- [ ] All tables have proper constraints and indexes
- [ ] Seed data for 120 cards (40 per faction) inserted
- [ ] Foreign key relationships properly established

### API Requirements
- [ ] All card retrieval endpoints functional
- [ ] Faction data endpoints working
- [ ] Proper error handling and status codes
- [ ] API documentation generated

### Data Quality
- [ ] Balanced cost curves across all factions
- [ ] Power level calculations validate properly
- [ ] No duplicate card names within factions
- [ ] All abilities reference valid ability types

### Integration Testing
- [ ] API endpoints respond within 100ms
- [ ] Database queries optimized and indexed
- [ ] Data validation prevents invalid cards
- [ ] Error handling covers all edge cases

## ðŸ§ª Testing Strategy

### Unit Tests
- Card validation logic
- Power level calculations
- Database model methods
- API endpoint responses

### Integration Tests
- Database CRUD operations
- API endpoint integration
- Data consistency validation
- Error handling scenarios

### Performance Tests
- Card retrieval query performance
- Bulk data operations
- Concurrent access testing
- Memory usage validation

## ðŸ“¦ Deliverables

1. **Database Schema**: Complete PostgreSQL schema with migrations
2. **Seed Data**: 120 balanced cards across three factions
3. **API Endpoints**: RESTful API for card and faction data
4. **Documentation**: API documentation and schema documentation
5. **Tests**: Comprehensive test suite with 90%+ coverage
6. **Service Layer**: CardService with all required methods

## ðŸš€ Implementation Notes

### Phase 1 Priority
Focus on core card system with basic abilities. Advanced ability system can be expanded in future phases.

### Performance Considerations
- Use database indexes for frequent queries
- Implement caching for static card data
- Optimize JSON queries for abilities

### Future Expansion
Design schema to support:
- Card versioning for balance updates
- User-generated content validation
- Advanced ability interactions
- Meta-analysis data collection

This foundation will support all subsequent game mechanics and provide the data infrastructure for the complete TCG Tactique experience.